---
import { Icon } from 'astro-icon/components'
import Layout from '../layouts/Layout.astro'
import MainContent from '../components/MainContent.astro'
import PageHeader from '../components/text/PageHeader.astro'
---

<Layout title="Robby Webb | Contact">
  <MainContent>
    <PageHeader text="Let's Get Started" />
    <form method="POST" class="form" name="contactForm" action="/success/" data-netlify="true">
      <!-- Name -->
      <div class="form-field">
        <input id="name" type="text" name="name" placeholder=" " required />
        <label for="name">Name: <span>*</span></label>
      </div>

      <!-- Email -->
      <div class="form-field">
        <input id="email" type="email" name="email" placeholder=" " required />
        <label for="email">Email: <span>*</span></label>
      </div>

      <!-- Services -->
      <div class="form-field">
        <p>What Can I Help You With?</p>

        <!-- Mixing -->
        <div class="checkbox">
          <input type="checkbox" id="mixing" name="mixing" value="Mixing" />
          <label for="mixing">Mixing</label>
        </div>

        <!-- Producing -->
        <div class="checkbox">
          <input type="checkbox" id="producing" name="producing" value="Producing" />
          <label for="producing">Producing</label>
        </div>

        <!-- Recording -->
        <div class="checkbox">
          <input type="checkbox" id="recording" name="recording" value="Recording" />
          <label for="recording">Recording</label>
        </div>
      </div>

      <!-- Relevant Links -->
      <div class="form-field">
        <div class="relevant-links">
          <input id="links" type="text" name="links" placeholder=" " />
          <label for="links">Relevant Links:</label>
          <button class="site-cta button" type="button"><Icon name="plus" /> Add Link</button>
        </div>
        <div class="link-container"></div>
        <p class="error">Please enter a valid URL (e.g. https://www.example.com)</p>
      </div>

      <!-- Message -->
      <div class="form-field">
        <textarea id="message" name="message" cols="30" rows="5" placeholder=" " required
        ></textarea>
        <label for="message">Tell Me About Your Project: <span>*</span></label>
      </div>
      <button class="site-cta button large" type="submit">Send Message</button>
    </form>
  </MainContent>
</Layout>

<style>
  .form {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing-base) + 2.5rem);
    margin: 0 auto var(--spacing-section);
    max-width: 800px;
  }

  .form-field {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: clamp(var(--size-xs), 2vw, var(--size-sm));

    & label,
    & p:not(.error) {
      color: var(--color-grey);
    }

    & p {
      margin: 0 0 0.5rem;
      font-size: clamp(var(--size-xs), 2vw, var(--size-sm));
    }

    & textarea {
      resize: vertical;
    }

    &:has(input[type='checkbox']:checked) p {
      color: var(--color-white);
    }

    & .checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;

      input {
        width: clamp(var(--size-xxs), 2vw, var(--size-xs));
        height: clamp(var(--size-xxs), 2vw, var(--size-xs));
        appearance: none;
        border: 1px solid var(--color-white);
        border-radius: var(--border-radius);

        &:checked {
          background-color: var(--color-pink);
        }

        &:checked + label {
          color: var(--color-white);
        }
      }
    }

    & .checkbox input,
    & .checkbox label {
      cursor: pointer;
    }

    & input,
    & textarea {
      padding: 0.5rem;
      color: var(--color-white);
      background-color: var(--color-black);
      font-weight: 300;
      border-bottom: 1px solid var(--color-white);
      border-top: none;
      border-left: none;
      border-right: none;
      border-radius: 0;
      outline: none;
      transition: all var(--transition-normal);
    }

    & input:focus,
    & textarea:focus {
      border-bottom: 1px solid var(--color-pink);
    }

    & input:not(:placeholder-shown):valid,
    & textarea:not(:placeholder-shown):valid {
      border-color: var(--color-white);
    }

    & input:not(:placeholder-shown):not(:valid),
    & textarea:not(:placeholder-shown):not(:valid) {
      border-color: var(--color-pink);
    }

    & input:not(:placeholder-shown):not(:valid) + label,
    & textarea:not(:placeholder-shown):not(:valid) + label {
      color: var(--color-pink);
    }

    &:not(:has(input[type='checkbox'])) label {
      position: absolute;
      top: 48%;
      left: 0.4rem;
      transform: translateY(-50%);
      transition: all var(--transition-normal);
    }

    & textarea + label {
      top: 1.5rem;
    }

    & input:not([type='checkbox']):focus + label,
    & textarea:focus + label,
    & span {
      color: var(--color-pink);
    }

    & input:not([type='checkbox']):not([name='links']):valid + label,
    & textarea:valid + label {
      color: var(--color-white);
    }

    & input:focus + label,
    & textarea:focus + label,
    & input:not(:placeholder-shown) + label,
    & textarea:not(:placeholder-shown) + label {
      top: -1rem;
      left: 0;
    }

    .relevant-links {
      position: relative;
      display: flex;
      flex-direction: row;
      gap: calc(var(--spacing-base));

      & input {
        flex: 1;

        &:not(:placeholder-shown) + label {
          color: var(--color-white);
        }
      }

      & label {
        top: 30%;
        color: var(--color-grey);
      }

      & .button {
        display: flex;
        align-items: center;
        gap: 0.5rem;

        &:hover [data-icon='plus'] {
          stroke: var(--color-black);
        }

        [data-icon='plus'] {
          width: 1rem;
          height: 1rem;
          stroke: var(--color-white);
          stroke-linecap: round;
          stroke-linejoin: round;
          stroke-width: 2;
          transition: all var(--transition-normal);
        }
      }
    }

    .link-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      font-size: var(--size-xxs);

      & .link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: var(--color-pink);
        border-radius: var(--border-radius);

        & span {
          text-transform: uppercase;
          letter-spacing: 0.05rem;
          color: var(--color-black);
        }

        & svg {
          width: 1rem;
          height: 1rem;
          padding: 0.1rem;
          color: var(--color-black);
          border-radius: var(--border-radius);
          transition: all var(--transition-normal);

          &[data-icon='close'] {
            cursor: pointer;

            &:hover {
              background-color: var(--color-white-faded);
            }
          }
        }
      }
    }

    .error {
      display: none;

      &.show {
        display: block;
      }
    }
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    // Get DOM elements
    const form = document.querySelector('.form') as HTMLFormElement
    const linkContainer = document.querySelector('.link-container')
    const linksInput = document.querySelector('.relevant-links input') as HTMLInputElement
    const addLinkButton = document.querySelector('.relevant-links button')
    const error = document.querySelector('.error') as HTMLElement

    // Store relevant links
    let links: string[] = []

    /**
     * Add a link to the list of relevant links and the DOM
     */
    function handleAddLink() {
      const value = linksInput?.value

      // Check that the input is a valid URL
      const URL_REGEX =
        /^(http(s)?:\/\/)?(www.)?([a-zA-Z0-9])+([\-\.]{1}[a-zA-Z0-9]+)*\.[a-zA-Z]{2,5}(:[0-9]{1,5})?(\/[^\s]*)?$/gm

      if (!URL_REGEX.test(value)) {
        error.classList.add('show')
        return
      }

      // Remove error message and add link to list
      error.classList.remove('show')

      // Link template
      linkContainer?.insertAdjacentHTML(
        'beforeend',
        `
          <div class="link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 19">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m6 12.326 6-6m-4-3 .463-.537a5 5 0 0 1 7.071 7.072l-.534.464m-5 5-.397.535a5.068 5.068 0 0 1-7.127 0 4.972 4.972 0 0 1 0-7.071L3 8.326"/>
            </svg>
            <span>${value}</span>
            <svg
              data-icon="close"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              aria-hidden="true"
              viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18 18 6M6 6l12 12"></path>
            </svg>
          </div>
        `
      )

      // Add link to list and clear input
      links.push(value)
      linksInput.value = ''
    }

    /**
     * Remove a link from the list of relevant links and the DOM
     * @param e - The event object
     */
    function handleRemoveLink(e: Event) {
      const eventTarget = e.target as HTMLElement

      if (eventTarget.getAttribute('data-icon') === 'close') {
        const linkValue = eventTarget.parentElement?.querySelector('span')?.textContent
        const linksWithSelectionRemoved = links.filter((link) => link !== linkValue)
        links = linksWithSelectionRemoved

        // remove link from DOM
        eventTarget.parentElement?.remove()
      }
    }

    /**
     * Submit the form with with correctly formatted data
     * @param e - The event object
     * @todo Format FormData with AJAX request -- see: https://docs.netlify.com/forms/setup/#submit-html-forms-with-ajax
     */
    function handleSubmit(e: Event) {
      e.preventDefault()

      if (links.length !== 0) {
        linksInput.value = links.join(', ')
      } else {
        linksInput.value = linksInput.value
      }

      form.submit()
    }

    // Event listeners
    addLinkButton?.addEventListener('click', handleAddLink)
    linkContainer?.addEventListener('click', handleRemoveLink)
    form?.addEventListener('submit', handleSubmit)
  })
</script>
